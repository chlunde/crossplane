
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.8/codemirror.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.8/codemirror.min.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.8/addon/lint/lint.min.css" integrity="sha512-jP1+o6s94WQS9boYeDP3Azh8ihI5BxGgBZNjkABhx05MqH5WuDzfzSnoPxGxVzWi/gxxVHZHvWkdRM6SMy5B0Q==" crossorigin="anonymous" referrerpolicy="no-referrer" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.8/theme/monokai.min.css" integrity="sha512-R6PH4vSzF2Yxjdvb2p2FA06yWul+U0PDDav4b/od/oXf9Iw37zl10plvwOXelrjV2Ai7Eo3vyHeyFUjhXdBCVQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js" integrity="sha512-CSBhVREyzHAjAFfBlIBakjoRUKp5h7VSweP0InR/pAJyptH7peuhCsqAI/snV+TwZmXZqoUklpXp6R6wMnYf5Q==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.8/addon/lint/yaml-lint.min.js" integrity="sha512-7iVs+YReo3FBJkUjfQj6GxgmTfhLOUXNvTkyA+hFK4hiyVbFXM26kpsTth9Wft+s56iNxXpJ0ai/gKH9AKhWoQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.8/mode/yaml/yaml.min.js" integrity="sha512-+aXDZ93WyextRiAZpsRuJyiAZ38ztttUyO/H3FZx4gOAOv4/k9C6Um1CvHVtaowHZ2h7kH0d+orWvdBLPVwb4g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<style>
 body {
     background: #232323; color: white;
     font-family: system-ui
 }
 .CodeMirror {
     height: auto;
 }
</style>
<h1>Flatplane</h1>
<table>
    <tr>
        <td>
<form method="POST" id="form">
    <h3>Composite resource:</h3>
    <textarea id="compositeResource" name="compositeResource" cols="90">
{{ .CompositeResource }}</textarea>
        <br />
    <h3>Composition:</h3>
    <textarea id="composition" name="composition" rows="30" cols="90">
{{ .Composition }}</textarea>
    <br />
    <input type="submit">
</form>
        </td>
        <td style="vertical-align:top">
            {{if .POST}}
            <h3>Rendered resources:</h3>
            {{end}}


            <textarea id="response" name="response" rows="30" cols="90">
{{ .Response }}</textarea>

            <pre id="error">
{{ .Error }}
            </pre>
        </td>
    </tr>
</table>

<script>
 var editorCR = CodeMirror.fromTextArea(document.getElementById("compositeResource"), {
     // TODO: why doesn't linting work?
     theme: "monokai",
     mode: "text/x-yaml",
     gutters: ['CodeMirror-lint-markers'],
     lint: true,
     lineNumbers: true
 });
 var editorC = CodeMirror.fromTextArea(document.getElementById("composition"), {
     theme: "monokai",
     language: "yaml",
     mode: "yaml",
     gutters: ['CodeMirror-lint-markers'],
     lint: true,
     lineNumbers: true
 });

 var editorResp = CodeMirror.fromTextArea(document.getElementById("response"), {
     theme: "monokai",
     language: "yaml",
     mode: "yaml",
     gutters: ['CodeMirror-lint-markers'],
     lint: true,
     lineNumbers: true
 });

 function change(instance, changeObj) {
     const payload = new URLSearchParams();
     payload.append('compositeResource', editorCR.getValue())
     payload.append('composition', editorC.getValue())

     fetch("/", {
         body: payload,
         headers: {
             "Content-Type": "application/x-www-form-urlencoded",
             "Accept": "application/json",
         },
         method: "post",
     })
         .then((response) => response.json())
         .then((data) => {
             console.dir(data)
             editorResp.setValue(data.Response)
             document.getElementById('error').innerHTML = data.Error
         });
 }

 editorCR.on("change", change)
 editorC.on("change", change)

</script>
